{"ast":null,"code":"(function (window) {\n  window.extractData = function () {\n    var ret = $.Deferred();\n\n    function onError() {\n      console.log('Loading error', arguments);\n      ret.reject();\n    }\n\n    function onReady(smart) {\n      if (smart.hasOwnProperty('patient')) {\n        var patient = smart.patient;\n        var pt = patient.read();\n        var obv = smart.patient.api.fetchAll({\n          type: 'Observation',\n          query: {\n            code: {\n              $or: ['http://loinc.org|8302-2', 'http://loinc.org|8462-4', 'http://loinc.org|8480-6', 'http://loinc.org|2085-9', 'http://loinc.org|2089-1', 'http://loinc.org|55284-4']\n            }\n          }\n        });\n        $.when(pt, obv).fail(onError);\n        $.when(pt, obv).done(function (patient, obv) {\n          var byCodes = smart.byCodes(obv, 'code');\n          var gender = patient.gender;\n          var fname = '';\n          var lname = '';\n\n          if (typeof patient.name[0] !== 'undefined') {\n            fname = patient.name[0].given.join(' ');\n            lname = patient.name[0].family.join(' ');\n          }\n\n          var height = byCodes('8302-2');\n          var systolicbp = getBloodPressureValue(byCodes('55284-4'), '8480-6');\n          var diastolicbp = getBloodPressureValue(byCodes('55284-4'), '8462-4');\n          var hdl = byCodes('2085-9');\n          var ldl = byCodes('2089-1');\n          var p = defaultPatient();\n          p.birthdate = patient.birthDate;\n          p.gender = gender;\n          p.fname = fname;\n          p.lname = lname;\n          p.height = getQuantityValueAndUnit(height[0]);\n\n          if (typeof systolicbp != 'undefined') {\n            p.systolicbp = systolicbp;\n          }\n\n          if (typeof diastolicbp != 'undefined') {\n            p.diastolicbp = diastolicbp;\n          }\n\n          p.hdl = getQuantityValueAndUnit(hdl[0]);\n          p.ldl = getQuantityValueAndUnit(ldl[0]);\n          ret.resolve(p);\n        });\n      } else {\n        onError();\n      }\n    }\n\n    FHIR.oauth2.ready(onReady, onError);\n    return ret.promise();\n  };\n\n  window.extractEncounter = function () {\n    var retEncounter = $.Deferred();\n\n    function onError() {\n      console.log('Loading error', arguments);\n      retEncounter.reject();\n    }\n\n    function onEncounterReady(smart) {\n      if (smart.hasOwnProperty('patient')) {\n        var getEncounters = smart.patient.api.fetchAll({\n          type: 'Encounter' //'Appointment',  //'Schedule',   //Encounter\n\n        });\n        $.when(getEncounters).fail(onError);\n        $.when(getEncounters).done(function (encounters) {\n          retEncounter.resolve(encounters);\n        });\n      } else {\n        onError();\n      }\n    }\n\n    FHIR.oauth2.ready(onEncounterReady, onError);\n    return retEncounter.promise();\n  };\n\n  window.extractAppointment = function () {\n    var retAppt = $.Deferred();\n\n    function onError() {\n      console.log('Loading error', arguments);\n      retAppt.reject();\n    }\n\n    function onAppointmentReady(smart) {\n      if (smart.hasOwnProperty('patient')) {\n        var patient = smart.patient;\n        var getAppointments = smart.patient.api.fetchAll({\n          type: 'Appointment',\n          //,  //'Schedule',   //Encounter\n          query: {\n            date: '2018',\n            patient: patient.id\n          }\n        });\n        $.when(getAppointments).fail(onError);\n        $.when(getAppointments).done(function (appointments) {\n          retAppt.resolve(appointments);\n        });\n      } else {\n        onError();\n      }\n    }\n\n    FHIR.oauth2.ready(onAppointmentReady, onError);\n    return retAppt.promise();\n  };\n\n  window.extractSchedule = function () {\n    var retSchedule = $.Deferred();\n\n    function onError() {\n      console.log('Loading error', arguments);\n      retSchedule.reject();\n    }\n\n    function onScheduleReady(smart) {\n      if (smart.hasOwnProperty('patient')) {\n        var patient = smart.patient;\n        var getSchedules = smart.api.fetchAll({\n          type: 'Schedule',\n          //,  //'Schedule',   //Encounter\n          query: {\n            _id: '1265426-633867-3121665-0,21265426-633867-3121665-15'\n          }\n        });\n        $.when(getSchedules).fail(onError);\n        $.when(getSchedules).done(function (schedules) {\n          retSchedule.resolve(schedules);\n        });\n      } else {\n        onError();\n      }\n    }\n\n    FHIR.oauth2.ready(onScheduleReady, onError);\n    return retSchedule.promise();\n  };\n\n  function defaultPatient() {\n    return {\n      fname: {\n        value: ''\n      },\n      lname: {\n        value: ''\n      },\n      gender: {\n        value: ''\n      },\n      birthdate: {\n        value: ''\n      },\n      height: {\n        value: ''\n      },\n      systolicbp: {\n        value: ''\n      },\n      diastolicbp: {\n        value: ''\n      },\n      ldl: {\n        value: ''\n      },\n      hdl: {\n        value: ''\n      }\n    };\n  }\n\n  function getBloodPressureValue(BPObservations, typeOfPressure) {\n    var formattedBPObservations = [];\n    BPObservations.forEach(function (observation) {\n      var BP = observation.component.find(function (component) {\n        return component.code.coding.find(function (coding) {\n          return coding.code == typeOfPressure;\n        });\n      });\n\n      if (BP) {\n        observation.valueQuantity = BP.valueQuantity;\n        formattedBPObservations.push(observation);\n      }\n    });\n    return getQuantityValueAndUnit(formattedBPObservations[0]);\n  }\n\n  function getQuantityValueAndUnit(ob) {\n    if (typeof ob != 'undefined' && typeof ob.valueQuantity != 'undefined' && typeof ob.valueQuantity.value != 'undefined' && typeof ob.valueQuantity.unit != 'undefined') {\n      return ob.valueQuantity.value + ' ' + ob.valueQuantity.unit;\n    } else {\n      return undefined;\n    }\n  }\n\n  window.drawVisualization = function (p) {\n    $('#holder').show();\n    $('#loading').hide();\n    $('#fname').html(p.fname);\n    $('#lname').html(p.lname);\n    $('#gender').html(p.gender);\n    $('#birthdate').html(p.birthdate);\n    $('#height').html(p.height);\n    $('#systolicbp').html(p.systolicbp);\n    $('#diastolicbp').html(p.diastolicbp);\n    $('#ldl').html(p.ldl);\n    $('#hdl').html(p.hdl);\n  };\n})(window);","map":{"version":3,"sources":["/Users/dqian/dq_src/mhn/mhnhub/mhn-container/src/mhn-smart-container.js"],"names":["window","extractData","ret","$","Deferred","onError","console","log","arguments","reject","onReady","smart","hasOwnProperty","patient","pt","read","obv","api","fetchAll","type","query","code","$or","when","fail","done","byCodes","gender","fname","lname","name","given","join","family","height","systolicbp","getBloodPressureValue","diastolicbp","hdl","ldl","p","defaultPatient","birthdate","birthDate","getQuantityValueAndUnit","resolve","FHIR","oauth2","ready","promise","extractEncounter","retEncounter","onEncounterReady","getEncounters","encounters","extractAppointment","retAppt","onAppointmentReady","getAppointments","date","id","appointments","extractSchedule","retSchedule","onScheduleReady","getSchedules","_id","schedules","value","BPObservations","typeOfPressure","formattedBPObservations","forEach","observation","BP","component","find","coding","valueQuantity","push","ob","unit","undefined","drawVisualization","show","hide","html"],"mappings":"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","sourcesContent":["(function(window){\n  window.extractData = function() {\n    var ret = $.Deferred();\n\n    function onError() {\n      console.log('Loading error', arguments);\n      ret.reject();\n    }\n\n    function onReady(smart)  {\n      if (smart.hasOwnProperty('patient')) {\n        var patient = smart.patient;\n        var pt = patient.read();\n        var obv = smart.patient.api.fetchAll({\n                    type: 'Observation',\n                    query: {\n                      code: {\n                        $or: ['http://loinc.org|8302-2', 'http://loinc.org|8462-4',\n                              'http://loinc.org|8480-6', 'http://loinc.org|2085-9',\n                              'http://loinc.org|2089-1', 'http://loinc.org|55284-4']\n                      }\n                    }\n                  });\n\n        $.when(pt, obv).fail(onError);\n\n        $.when(pt, obv).done(function(patient, obv) {\n          var byCodes = smart.byCodes(obv, 'code');\n          var gender = patient.gender;\n\n          var fname = '';\n          var lname = '';\n\n          if (typeof patient.name[0] !== 'undefined') {\n            fname = patient.name[0].given.join(' ');\n            lname = patient.name[0].family.join(' ');\n          }\n\n          var height = byCodes('8302-2');\n          var systolicbp = getBloodPressureValue(byCodes('55284-4'),'8480-6');\n          var diastolicbp = getBloodPressureValue(byCodes('55284-4'),'8462-4');\n          var hdl = byCodes('2085-9');\n          var ldl = byCodes('2089-1');\n\n          var p = defaultPatient();\n          p.birthdate = patient.birthDate;\n          p.gender = gender;\n          p.fname = fname;\n          p.lname = lname;\n          p.height = getQuantityValueAndUnit(height[0]);\n\n          if (typeof systolicbp != 'undefined')  {\n            p.systolicbp = systolicbp;\n          }\n\n          if (typeof diastolicbp != 'undefined') {\n            p.diastolicbp = diastolicbp;\n          }\n\n          p.hdl = getQuantityValueAndUnit(hdl[0]);\n          p.ldl = getQuantityValueAndUnit(ldl[0]);\n\n          ret.resolve(p);\n        });\n      } else {\n        onError();\n      }\n    }\n\n    FHIR.oauth2.ready(onReady, onError);\n    return ret.promise();\n\n  };\n\n  window.extractEncounter = function() {\n    var retEncounter = $.Deferred();\n\n    function onError() {\n      console.log('Loading error', arguments);\n      retEncounter.reject();\n    }\n\n    \n    function onEncounterReady(smart)  {\n      if (smart.hasOwnProperty('patient')) {\n          var getEncounters = smart.patient.api.fetchAll({\n                    type: 'Encounter'  //'Appointment',  //'Schedule',   //Encounter\n                  });\n\n          $.when(getEncounters).fail(onError);\n\n          $.when(getEncounters).done( function(encounters) {\n             retEncounter.resolve(encounters); \n          } );\n        \n\n      } else {\n        onError();\n      }\n     \n    }\n\n    FHIR.oauth2.ready(onEncounterReady, onError);\n    return retEncounter.promise();\n\n  };\n\n  window.extractAppointment = function() {\n    var retAppt = $.Deferred();\n\n    function onError() {\n      console.log('Loading error', arguments);\n      retAppt.reject();\n    }\n\n\n    function onAppointmentReady(smart)  {\n      if (smart.hasOwnProperty('patient')) {\n          var patient = smart.patient;\n          var getAppointments = smart.patient.api.fetchAll({\n                    type: 'Appointment',   //,  //'Schedule',   //Encounter\n                    query: { date: '2018', patient: patient.id }\n                  });\n\n          $.when(getAppointments).fail(onError);\n\n          $.when(getAppointments).done( function(appointments) {\n             retAppt.resolve(appointments);\n          } );\n\n\n      } else {\n        onError();\n      }\n\n    }\n\n    FHIR.oauth2.ready(onAppointmentReady, onError);\n    return retAppt.promise();\n\n  };\n\n\n\nwindow.extractSchedule = function() {\n    var retSchedule = $.Deferred();\n\n    function onError() {\n      console.log('Loading error', arguments);\n      retSchedule.reject();\n    }\n\n\n    function onScheduleReady(smart)  {\n      if (smart.hasOwnProperty('patient')) {\n          var patient = smart.patient;\n          var getSchedules = smart.api.fetchAll({\n                    type: 'Schedule',   //,  //'Schedule',   //Encounter\n                    query: { _id: '1265426-633867-3121665-0,21265426-633867-3121665-15'}\n                  });\n\n          $.when(getSchedules).fail(onError);\n\n          $.when(getSchedules).done( function(schedules) {\n             retSchedule.resolve(schedules);\n          } );\n\n\n      } else {\n        onError();\n      }\n\n    }\n\n    FHIR.oauth2.ready(onScheduleReady, onError);\n    return retSchedule.promise();\n\n}\n\n\n  function defaultPatient(){\n    return {\n      fname: {value: ''},\n      lname: {value: ''},\n      gender: {value: ''},\n      birthdate: {value: ''},\n      height: {value: ''},\n      systolicbp: {value: ''},\n      diastolicbp: {value: ''},\n      ldl: {value: ''},\n      hdl: {value: ''},\n    };\n  }\n\n  function getBloodPressureValue(BPObservations, typeOfPressure) {\n    var formattedBPObservations = [];\n    BPObservations.forEach(function(observation){\n      var BP = observation.component.find(function(component){\n        return component.code.coding.find(function(coding) {\n          return coding.code == typeOfPressure;\n        });\n      });\n      if (BP) {\n        observation.valueQuantity = BP.valueQuantity;\n        formattedBPObservations.push(observation);\n      }\n    });\n\n    return getQuantityValueAndUnit(formattedBPObservations[0]);\n  }\n\n  function getQuantityValueAndUnit(ob) {\n    if (typeof ob != 'undefined' &&\n        typeof ob.valueQuantity != 'undefined' &&\n        typeof ob.valueQuantity.value != 'undefined' &&\n        typeof ob.valueQuantity.unit != 'undefined') {\n          return ob.valueQuantity.value + ' ' + ob.valueQuantity.unit;\n    } else {\n      return undefined;\n    }\n  }\n\n  window.drawVisualization = function(p) {\n    $('#holder').show();\n    $('#loading').hide();\n    $('#fname').html(p.fname);\n    $('#lname').html(p.lname);\n    $('#gender').html(p.gender);\n    $('#birthdate').html(p.birthdate);\n    $('#height').html(p.height);\n    $('#systolicbp').html(p.systolicbp);\n    $('#diastolicbp').html(p.diastolicbp);\n    $('#ldl').html(p.ldl);\n    $('#hdl').html(p.hdl);\n  };\n\n})(window);\n"]},"metadata":{},"sourceType":"module"}